<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>RS</title>
</head>
<body>
    <div class="container main_container" >
        <div class="row upper_panel d-flex justify-content-start align-items-center" style="">
            <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                <span class="d-flex justify-content-center">სტატუსები</span>
                <div class="inner_container">
                    <div>
                        <input type="checkbox" class="status" id="status_1", value="1"> 
                        <label for="status_1">აქტივირებული</span>
                    </div>
                    <div>
                        <input type="checkbox" class="status" id="status_2", value="2"> 
                        <label for="status_2">დასრულებული</span>
                    </div>
                    <div>
                        <input type="checkbox" class="status" id="status_3", value="0"> 
                        <label for="status_3">შენახული</span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <span class="d-flex justify-content-center">ზედნადების ტიპები</span>
                <div class="row inner_container">
                    <div class="d-flex align-items-center" id="typesCheckboxes">
                        <div class="col-7" >
                            <div>
                                <input type="checkbox" id="inner" value="1"> 
                                <label for="inner">შიდა გადაზიდვა</label>
                            </div>
                            <div>
                                <input type="checkbox" id="transport" value="2"> 
                                <label for="transport"> ტრანსპორტირებით </label>
                            </div>
                            <div>
                                <input type="checkbox" id="without_transport" value="3"> 
                                <label for="without_transport"> ტრანსპორტირების გარ.. </label>
                            </div>
                        </div>

                        <div class="col-5">
                            <div>
                                <input type="checkbox" id="dist" value="4"> 
                                <label for="dist"> დისტრიბუცია </label>
                            </div>
                            <div>
                                <input type="checkbox" id="return" value="5"> 
                                <label for="return"> უკან დაბრუნება </label>
                            </div>
                            <div>
                                <input type="checkbox" id="sub" value="6"> 
                                <label for="sub"> ქვე-ზედნადები </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-2">
                <div class="inner_container d-flex flex-column justify-content-center" style="border: none">
                    <span class="d-flex justify-content-center" >ფილტრაცია</span>
                    <div class="d-flex justify-content-center">
                        <input type="text" placeholder="" class="filter_input" id="filterValue">
                    </div>
                    <span class="d-flex justify-content-center">ჯამი</span>
                    <div class="d-flex justify-content-center">
                        <input type="text" placeholder="" class="filter_input" id="total" readonly>
                    </div>
                </div>
            </div>

            <div class="col-md-2 d-flex flex-column justify-content-center align-items-center date_filter">
                <div>
                    <input type="date" id="startDate" style="margin: 0">
                </div>

                <button class="d-flex" style="background-color: transparent;" onclick="filterData()">
                    <img src="static/images/rs.png" width="20" height="20">
                </button>
                
                <div style="margin: 0">
                    <input type="date" id="endDate">
                </div>
            </div>

            <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                <span>ობიექტები</span>
                <div class="inner_container">
                    <select name="cars" id="cars">
                        <option value="volvo">5000</option>
                    </select>
                </div>
            </div>
        </div>
        
        <br>
        <div class="row">
            <table class="table table-bordered" id="dataTable1">
                <thead id="columns">
                
                </thead>
                <tbody id="rows">
                    
                </tbody>
            </table>
        </div>
        
        <div class="row">
            <table class="table table-bordered" id="dataTable2">
                <thead id="columns2">
                </thead>
                <tbody id="rows2">
                </tbody>
            </table>
        </div>
    </div>
 
</body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        const getWaybillsXML = `<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">  <soap:Body><get_buyer_waybills xmlns="http://tempuri.org/">      <su>mega:405453959</su>      <sp>12345654321</sp><itypes>,1,2,3,6,</itypes><seller_tin /><statuses>,1,2,</statuses><car_number /><begin_date_s>${new Date().toISOString().slice(0,10)}</begin_date_s><begin_date_e>${new Date().toISOString().slice(0,10)}</begin_date_e><create_date_s xsi:nil="true" /><create_date_e xsi:nil="true" /><driver_tin />><delivery_date_s xsi:nil="true" /><delivery_date_e xsi:nil="true" /><full_amount xsi:nil="true" /><waybill_number /><close_date_s xsi:nil="true" /><close_date_e xsi:nil="true" /><s_user_ids /><comment /></get_buyer_waybills></soap:Body></soap:Envelope>`;
        const getWaybillXML = '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><get_waybill xmlns="http://tempuri.org/"><su>mega:405453959</su><sp>12345654321</sp><waybill_id>int</waybill_id></get_waybill></soap:Body></soap:Envelope>';

        const types = ["შიდა გადაზიდვა", "ტრანსპორტირებით", "ტრანსპორტირების გარეშე", "დისტრიბუცია", "უკან დაბრუნება", "ქვე-ზედნადები"];
        const statuses = ["შენახული", "აქტივირებული", "დასრულებული"]
        const units = {"1":"ცალი", "2":"კგ", "3":"გრამი", "4":"ლიტრი", "5":"ტონა", "7":"სანტიმეტრი", "8":"მეტრი", "9":"კილომეტრი", "10":"კვ.სმ", "11":"კვ.მ", "12":"კუბ.მ", "13":"მილიმეტრი",  "99":"სხვა", "14":"შეკვრა"}
        const fields1 = ["ზედნადები", "ტიპი", "სტატუსი", "მომწოდებელი", "საიდენტიფიკაციო", "თანხა", "ტრანსპ. დასასრული", "დაწყ. თარიღი"];
        const parser = new DOMParser();

        async function fetchData(xml, promise) {
            const response = await fetch("/fetch_data", {
                method: "POST",
                headers: {
                    "Content-Type": "text/xml",
                },
                body: xml,
            });
            let data = await response.text();
            data = data.replace(/\\(.)/g, "$1").slice(1, -1);
            let dataXML = parser.parseFromString(data, "application/xml");
            return dataXML;
        }

        function replaceStatusesOrTypes(xmlObj, statuses, field) {
            const elem = xmlObj.querySelector(field);
            let str = "";
            statuses.forEach(s => {
                str += "," + s
            })
            str += ",";
            elem.textContent = str;
            return xmlObj;
        }

        function replaceDates(xmlObj, newDate1, newDate2) {
            const dateBegineElem = xmlObj.querySelector("begin_date_e");
            const dateBeginsElem = xmlObj.querySelector("begin_date_s");

            dateBeginsElem.textContent = newDate1 + "T00:00:00";
            dateBegineElem.textContent = newDate2 + "T23:59:59";
            return xmlObj;
        }

        let multipleDatesData = 0;
        function temp(data) {
            multipleDatesData = data;
        }

        function dateToString(date) {
            let month = (date.getMonth()+1).toString();
            let day = (date.getDate()).toString();
            parseInt(month) < 10 ? month = "0" + month : null;
            parseInt(day) < 10 ? day = "0" + day : null;
            let stringDate = `${date.getFullYear()}-${month}-${day}`
            return stringDate
        }

        async function fetchFromMultipleDates(dates, filteredXMLObj) {
            let multipleDatesData = 0;
            let xmlString;
            let data;
            let startDate;
            dates[dates.length-1].setDate(dates[dates.length-1].getDate() + 1);
            for (let [index, item] of dates.slice(0, dates.length-1).entries()) {
                startDate = item;
                if (index > 0) {
                    startDate.setDate(startDate.getDate() + 1)
                }

                filteredXMLObj = replaceDates(filteredXMLObj, dateToString(startDate), dateToString(dates[index+1]));
                xmlString = new XMLSerializer().serializeToString(filteredXMLObj);
                console.log(dates)
                data = await fetchData(xmlString, 0) 
                let waybills = data.querySelector("WAYBILL_LIST");
                if (multipleDatesData) {
                    for (const elem of waybills.querySelectorAll("WAYBILL")) {
                        multipleDatesData.appendChild(elem);
                    }
                }
                else { 
                    multipleDatesData = waybills; 
                }
            }
            return multipleDatesData;
        }

        async function filterData() {
            let startDate = document.querySelector("#startDate");
            let endDate = document.querySelector("#endDate");
            let statuses = document.querySelectorAll(".status:checked");
            let types = document.querySelectorAll("#typesCheckboxes input:checked");
            let filterValue = document.querySelector("#filterValue").value;

            let statusesValues = [];
            let typesValues = [];
            let filteredXMLObj = parser.parseFromString(getWaybillsXML, "application/xml");

            if (statuses.length) {
                statuses.forEach(item => {
                    statusesValues.push(item.value);
                })
                filteredXMLObj = replaceStatusesOrTypes(filteredXMLObj, statusesValues, "statuses");
            }
            
            if (types.length) {
                types.forEach(item => {
                    typesValues.push(item.value);
                })
                filteredXMLObj = replaceStatusesOrTypes(filteredXMLObj, typesValues, "itypes");
            }
            
            if ((startDate.value + endDate.value).length) {
                let data;
                let startDateObj = new Date(startDate.value);
                let endDateObj = new Date(endDate.value);
                let range = endDateObj.getDate() - startDateObj.getDate();

                if (range >= 3) {
                    let dates = [startDateObj];
                    let num = Math.floor(range/3);
                    let curDate;
                    for (let i = 0; i < num; i++) {
                        curDate = new Date(dates[i]);
                        curDate.setDate(curDate.getDate() + 2)
                        dates.push(curDate)
                    }
                    if (range % 3) {
                        curDate = new Date(dates[dates.length-1]);
                        curDate.setDate(curDate.getDate() + (range % 3));
                        dates.push(curDate);
                    }
                    data = await fetchFromMultipleDates(dates, filteredXMLObj);
                    fillTable(data, filterValue);
                }
                else {
                    filteredXMLObj = replaceDates(filteredXMLObj, startDate.value, endDate.value);
                    let xmlString = new XMLSerializer().serializeToString(filteredXMLObj);
                    data = await fetchData(xmlString);
                    fillTable(data.querySelector("WAYBILL_LIST"), filterValue);
                }
            }
        }

        function prepareGetwaybillXML(waybillID) {
            const xmlDoc = parser.parseFromString(getWaybillXML, "application/xml");
            const waybillIDElem = xmlDoc.querySelector("waybill_id");
            waybillIDElem.textContent = waybillID;
            return new XMLSerializer().serializeToString(xmlDoc);
        }

        function fillProductsTable(data) {
            let keys = ["W_NAME", "UNIT_ID", "QUANTITY", "AMOUNT", "PRICE", "total_price", "BAR_CODE"]
            let goodsData = data.querySelector("GOODS_LIST").childNodes;

            const rows2 = document.querySelector("#rows2");
            rows2.innerHTML = "";
            for (let obj of goodsData) {
                let tbodyRow2 = rows2.insertRow();
                obj.querySelector("UNIT_ID").textContent = units[parseInt(obj.querySelector("UNIT_ID").textContent)];

                let quantity = parseFloat(obj.querySelector("QUANTITY").textContent);
                let amount = parseFloat(obj.querySelector("AMOUNT").textContent);
                let newElem = document.createElement("TOTAL_PRICE");
                newElem.textContent = Math.round((quantity * amount) * 100) / 100;
                obj.insertBefore(newElem, obj.querySelector("BAR_CODE"));

                for (let key of keys) {
                    let content = obj.querySelector(key).textContent;
                    let cell2 = tbodyRow2.insertCell();
                    cell2.textContent = content;
                }
            }
        }

        function fillTable(data, filterValue) {
            const keys = ["ID", "TYPE", "STATUS", "SELLER_NAME", "BUYER_TIN", "FULL_AMOUNT", "END_ADDRESS", "BEGIN_DATE"];
            let preparedData = data;
            preparedData = (typeof(preparedData) === "undefined" || typeof(preparedData) === null) ? [] : preparedData.childNodes;

            let lastClicked = 0;
            let total = 0;
            const rows = document.querySelector("#rows");
            rows.innerHTML = "";
            for (const obj of preparedData) {
                if (filterValue.length && 
                    (!obj.querySelector("SELLER_NAME").textContent.includes(filterValue) && !obj.querySelector("ID").textContent.includes(filterValue) && !obj.querySelector("BUYER_TIN").textContent.includes(filterValue))) {
                    continue;
                }
                const tbodyRow = rows.insertRow();

                total += parseFloat(obj.querySelector("FULL_AMOUNT").textContent);
                obj.querySelector("TYPE").textContent = types[parseInt(obj.querySelector("TYPE").textContent)-1];
                obj.querySelector("STATUS").textContent = statuses[parseInt(obj.querySelector("STATUS").textContent)]
                obj.querySelector("BEGIN_DATE").textContent = obj.querySelector("BEGIN_DATE").textContent.replace("T", " ")

                tbodyRow.addEventListener("click", () => {
                    if (lastClicked) {
                        lastClicked.style.backgroundColor = "white"
                    }
                    lastClicked = tbodyRow;
                    let xml = prepareGetwaybillXML(obj.querySelector("ID").textContent);
                    fetchData(xml, 0).then(preparedData => {
                        fillProductsTable(preparedData);
                    })
                })

                tbodyRow.addEventListener("mouseover", () => {
                    tbodyRow.style.backgroundColor = "#3236392f";
                    tbodyRow.style.cursor = "pointer";
                })

                tbodyRow.addEventListener("mouseleave", () => {
                    if (tbodyRow !== lastClicked) {
                        tbodyRow.style.backgroundColor = "white"
                    }
                })

                for (let key of keys) {
                    let content = obj.querySelector(key).textContent
                    const cell = tbodyRow.insertCell();
                    cell.textContent = content;
                }
            }
            document.querySelector("#total").value = Math.round(total * 100) / 100;;
        }
        
        fetchData(getWaybillsXML, 0).then((data) => {
            let thead = document.querySelector("#columns");
            let theadRow = thead.insertRow();
            let thead2 = document.querySelector("#columns2");
            let fields2 = ["RS დასახელება", "ერთეული", "რაოდენობა", "RS ფასი", "ფასი", "ჯამი", "RS კოდი"];
            let theadRow2 = thead2.insertRow();

            fields2.forEach((field) => {
                let th = document.createElement("th");
                th.textContent = field;
                theadRow2.appendChild(th)
            })  

            fields1.forEach((field) => {
                let th = document.createElement("th");
                th.textContent = field;
                theadRow.appendChild(th)
            })
            
            let checkboxes = document.querySelectorAll("input[type='checkbox']");

            checkboxes.forEach((checkbox) => {
                if (!["0","4","5"].includes(checkbox.value)) {checkbox.checked = true;}
                checkbox.addEventListener("change", () => {
                    filterData();
                });
            });

            document.querySelector("#filterValue").addEventListener("keypress", function(event) {
                if (event.keyCode === 13) {
                    filterData();
                }
            });
            startDate.addEventListener("change", () => {
                filterData();
            })
            endDate.addEventListener("change", () => {
                filterData();
            })

            fillTable(data.querySelector("WAYBILL_LIST"), "");
        })

    </script>
</html>