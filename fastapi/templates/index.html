<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="{{ url_for('static', path='/css/styles.css') }}" rel="stylesheet">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <h4>Date Range Selector</h4>
        <div class="row">
            <div class="col">
                <label for="startDate">From:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col">
                <label for="endDate">To:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col" style="display: flex; align-items: end;">
                <button type="submit" class="btn btn-primary" onclick="filterByDate()">Filter</button>
            </div>
        </div>
        <br>
        <table class="table table-striped table-bordered" id="dataTable">
            <thead id="columns">
               
            </thead>
            <tbody id="rows">

            </tbody>
        </table>
    </div>
 
</body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        const xmlData = '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">  <soap:Body><get_buyer_waybills xmlns="http://tempuri.org/">      <su>mega:405453959</su>      <sp>12345654321</sp><itypes>,1,2,3,6,</itypes><seller_tin /><statuses>,1,2,</statuses><car_number /><begin_date_s>2023-04-28T00:00:00</begin_date_s><begin_date_e>2023-04-28T23:59:59</begin_date_e><create_date_s xsi:nil="true" /><create_date_e xsi:nil="true" /><driver_tin />><delivery_date_s xsi:nil="true" /><delivery_date_e xsi:nil="true" /><full_amount xsi:nil="true" /><waybill_number /><close_date_s xsi:nil="true" /><close_date_e xsi:nil="true" /><s_user_ids /><comment /></get_buyer_waybills></soap:Body></soap:Envelope>';

        const types = ["შიდა გადაზიდვა", "ტრანსპორტირებით", "ტრანსპორტირების გარეშე", "დისტრიბუცია", "უკან დაბრუნება", "ქვე-ზედნადები"];
        const statuses = ["შენახული", "აქტივირებული", "დასრულებული"]
        const keys = ["ID", "TYPE", "STATUS", "SELLER_NAME", "BUYER_TIN", "FULL_AMOUNT", "END_ADDRESS", "BEGIN_DATE"];
        const fields = ["ზედნადები", "ტიპი", "სტატუსი", "მომწოდებელი", "საიდენტიფიკაციო", "თანხა", "ტრანსპ. დასასრული", "დაწყ. თარიღი"];

        const parser = new DOMParser();

        function replaceDates(xmlString, newDate1, newDate2) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");

            const dateBegineElem = xmlDoc.getElementsByTagName("begin_date_e")[0];
            const dateBeginsElem = xmlDoc.getElementsByTagName("begin_date_s")[0];

            dateBegineElem.textContent = newDate1;
            dateBeginsElem.textContent = newDate2;

            return new XMLSerializer().serializeToString(xmlDoc);
        }

        async function fetchData(xml) {
            const response = await fetch("/fetch_data", {
                method: "POST",
                headers: {
                    "Content-Type": "text/xml",
                },
                body: xml,
            });
            const data = await response.json();
            let preparedData = data["soap:Envelope"]["soap:Body"]["get_buyer_waybillsResponse"]["get_buyer_waybillsResult"]["WAYBILL_LIST"]["WAYBILL"];
            return preparedData;
        }

        const table = document.querySelector("#dataTable");
        const rows = document.querySelector("#rows");

        function fillTable(data) {
            const filteredData = data.map(item => {
                let newItem = {};
                keys.forEach((field) => {
                    newItem[field] = item[field];
                })
                return newItem;
            })
            document.querySelector("#rows").innerHTML = "";
            for (let obj of filteredData) {
                const tbodyRow = rows.insertRow();
                // console.log(obj["TYPE"])
                obj["TYPE"] = types[parseInt(obj["TYPE"])-1];
                obj["STATUS"] = statuses[parseInt(obj["STATUS"]-1)]

                for (let key in obj) {
                    content = obj[key];
                    const cell = tbodyRow.insertCell();
                    cell.textContent = content;
                }
            }
        }

        // doesnt work
        function filterByDate() {
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            let startDate = document.querySelector("#startDate");
            let endDate = document.querySelector("#endDate");
            let filteredXML = replaceDates(xmlData, startDate.value, endDate.value);
            console.log(filteredXML)
            fetchData(filteredXML).then((data) => {
                fillTable(data);
            });
        }
        
        function getWaybill() {
            let xml = '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><get_waybill xmlns="http://tempuri.org/"><su>mega:405453959</su><sp>12345654321</sp><waybill_id>772755411</waybill_id></get_waybill></soap:Body></soap:Envelope>'
            const waybillId = xmlDoc.getElementsByTagName("waybill_id")[0];
            return new XMLSerializer().serializeToString(xmlDoc);
        }

            const thead = document.querySelector("#columns");
            fetchData(xmlData).then((data) => {
                const theadRow = thead.insertRow();
                fields.forEach((field) => {
                    let th = document.createElement("th");
                    th.textContent = field;
                    theadRow.appendChild(th)
                    // const headerCell = theadRow.insertCell();
                    // headerCell.textContent = key;
                })
            fillTable(data);
        })
    </script>
</html>